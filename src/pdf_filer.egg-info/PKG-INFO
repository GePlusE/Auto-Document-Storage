Metadata-Version: 2.4
Name: pdf-filer
Version: 0.1.0
Summary: Local PDF auto-filing on macOS with Vision OCR + multi-stage Ollama classification + SQLite logging.
Author: You
License: MIT
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: pymupdf>=1.24.0
Requires-Dist: PyYAML>=6.0.1
Requires-Dist: requests>=2.31.0
Requires-Dist: rich>=13.7.0
Requires-Dist: pyobjc-core>=10.0
Requires-Dist: pyobjc-framework-Vision>=10.0
Requires-Dist: pyobjc-framework-Quartz>=10.0
Requires-Dist: pyobjc-framework-Cocoa>=10.0

# pdf-filer (macOS)

Automates filing scanned PDFs from an input folder ("Ablage") into subfolders under a target folder ("Dokumente").
Works fully locally using:
- PDF text extraction (text layer) + fallback OCR via **macOS Vision**
- Multi-stage sender classification via **Ollama** (small model first, bigger model on low confidence)
- SQLite logging of all model outputs and routing decisions
- Daily automation via **launchd** (no cron)

## Features
- Processes **all PDFs currently in the input folder** (no state tracking required because files get moved out)
- Renames PDFs with a date prefix `YYYY-MM-DD` using **file/PDF metadata only** (never from PDF text)
- Collision handling: appends `_1`, `_2`, ... if a filename already exists in the destination folder
- Safe fallback folder for uncertain classification (`Dokumente/_Unklar`)
- Stores raw model JSON responses (stage1 + stage2 + final) in SQLite for later analysis

## Setup

### 1) Create venv & install
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -U pip
pip install -e .
```

> Note: `pyobjc-*` dependencies are macOS-only. Install on macOS.

### 2) Install & start Ollama
Install Ollama and pull models, e.g.:
```bash
ollama pull qwen2.5:1.5b-instruct
ollama pull qwen2.5:3b-instruct
```
Ensure Ollama server is running (default `http://localhost:11434`).

### 3) Configure
Copy and edit:
- `config.example.yaml` → `~/.pdf_filer/config.yaml`
- `sender_mapping.example.json` → `~/.pdf_filer/sender_mapping.json`

### 4) Run manually
```bash
pdf-filer run --config ~/.pdf_filer/config.yaml
```
Dry run:
```bash
pdf-filer run --config ~/.pdf_filer/config.yaml --dry-run
```

### 5) launchd automation
Edit `launchd/com.user.pdf_filer.plist`:
- Replace `<USER>` with your username
- Update paths to your venv python if needed

Then:
```bash
mkdir -p ~/Library/LaunchAgents
cp launchd/com.user.pdf_filer.plist ~/Library/LaunchAgents/
launchctl unload ~/Library/LaunchAgents/com.user.pdf_filer.plist 2>/dev/null || true
launchctl load ~/Library/LaunchAgents/com.user.pdf_filer.plist
launchctl list | grep pdf_filer
```

To view logs:
- See `logs_dir` in config (defaults to `~/.pdf_filer/logs/`)

## Notes on accuracy
- Best results come from high-quality scans.
- Vision OCR is good, but for very noisy documents you may want to increase `ocr.max_pages` or `ocr.dpi`.
- The SQLite DB (`db_path`) lets you review low-confidence/unknown cases to update your mapping JSON.

## Development / tests
```bash
pytest -q
```

